{
    "collab_server" : "",
    "contents" : "library(tidyverse)\nlibrary(RColorBrewer)\nlibrary(scales)\nlibrary(extrafont)\nlibrary(grid)\nlibrary(gridExtra)\n\n#загружаем БД\ndf <- read_csv(\"dp_debt_full.csv\") %>%\n  mutate(debtor = ifelse(debt != 0, \"ДП з боргом\", \"ДП без боргу\"))\n\n#палитра\ndebtByKvedColors <- brewer.pal(5, \"Blues\")\ndebtByHeadColors <- brewer.pal(5, \"Oranges\")\n\n#нижний колонтитул\nfootnote <-\n  \"графіка проекту \\\"Ціна держави\\\" за даними https://opendatabot.com\"\n\n#расчет суммы долга по отрасли для последующей сортировки и подписи данных\ndebtByKved <- df %>%\n  group_by(custom_section) %>%\n  mutate(d_sum = sum(debt))\n\n#создаем график №1\n#для экспорта размером 700х650\ndebtByKvedPlot <- ggplot(data = debtByKved) +\n  geom_bar(\n    #сортировка столбцов\n    mapping = aes(\n      x = reorder(custom_section, d_sum),\n      fill = factor(debtor, levels = c(\"ДП з боргом\", \"ДП без боргу\"))\n    ),\n    #bar stroke\n    color = \"#FFFFFF\",\n    #процентное представление\n    position = \"fill\"\n  ) +\n  #horizontal bars\n  coord_flip() +\n  #процентная шкала\n  scale_y_continuous(labels = percent) +\n  #reverse palette\n  scale_fill_manual(values = rev(c(debtByKvedColors[3], debtByKvedColors[5])),\n                    #reverse legend\n                    guide = guide_legend(reverse = TRUE)) +\n  #подписи столбцов\n  #выбираем по одному значению для отрасли, чтобы надписи не накладывались друг на друга\n  geom_text(\n    data = unique(debtByKved[, c(\"custom_section\", \"d_sum\")]),\n    mapping = aes(\n      x = custom_section,\n      label = ifelse(\n        d_sum / 1000000000 > 1,\n        #округление до десятых\n        paste(sprintf(\n          \"%3.1f\", round(d_sum / 1000000000, digits = 1)\n        ), \"млрд\", sep = \" \"),\n        #округление до большего целого\n        paste(ceiling(d_sum / 1000000), \"млн\", sep = \" \")\n      ),\n      y = 1\n    ),\n    hjust = 1.1,\n    vjust = 0.35,\n    size = 3,\n    color = \"#FFFFFF\"\n  ) +\n  #внешний вид графика\n  theme(\n    #основной шрифт\n    text = element_text(family = \"PT Sans\", size = 19),\n    plot.title = element_text(\n      face = \"bold\",\n      margin = margin(\n        t = 0,\n        r = 20,\n        b = 20,\n        l = 20,\n        unit = \"pt\"\n      )\n    ),\n    plot.subtitle = element_text(\n      #относительный размер шрифта\n      size = rel(0.65),\n      margin = margin(\n        t = 0,\n        r = 20,\n        b = 35,\n        l = 20,\n        unit = \"pt\"\n      )\n    ),\n    legend.text = element_text(\n      size = rel(0.6),\n      margin = margin(\n        t = 0,\n        r = 20,\n        b = 30,\n        l = 20,\n        unit = \"pt\"\n      )\n    ),\n    axis.text.y = element_text(size = rel(0.63)),\n    axis.text.x = element_text(size = rel(0.5)),\n    axis.title.x = element_text(size = rel(0.6)),\n    #отключаем отображение отдельных элементов\n    panel.grid.major = element_blank(),\n    panel.grid.minor = element_blank(),\n    panel.background = element_blank(),\n    axis.ticks.y = element_blank(),\n    axis.title.y = element_blank(),\n    legend.position = \"top\",\n    legend.title = element_blank(),\n    plot.margin = unit(c(45, 20, 40, 20), \"pt\")\n  ) +\n  #заголовки и подписи осей\n  labs(y = \"питома вага боржників (%) і абсолютна сума боргу (грн)\",\n       title = \"Розподіл податкового боргу ДП\\nза видами діяльності\",\n       subtitle = \"Найбільший відсоток неефективних ДП зафіксовано у видобувній\\nгалузі. Сукупний борг таких піприємств перед бюджетом на\\n01.02.2017 перевищує 3 млрд грн.\")\n\n#добавление нижнего колонтитула\n#http://statmodeling.com/best-way-to-add-a-footnote-to-a-plot-created-with-ggplot2.html\ng <-\n  arrangeGrob(debtByKvedPlot,\n              bottom = textGrob(\n                footnote,\n                x = 0,\n                hjust = -0.5,\n                vjust = -0.5,\n                gp = gpar(fontface = \"italic\", fontsize = 10)\n              ))\n\n#выборка ТОП-должников по ведомствам\nbyHeadTop <- df %>%\n  group_by(head) %>%\n  summarise(d_sum = sum(debt)) %>%\n  arrange(desc(d_sum)) %>%\n  head(16) %>%\n  select(head)\n\n#ккороткие названия ведомств\nhead_short <-\n  c(\n    \"Міненергетики\",\n    \"Мінагрополітики\",\n    \"Укроборонпром і Міноборони\",\n    \"Фонд держмайна\",\n    \"Мінекономрозвитку\",\n    \"Укроборонпром і Міноборони\",\n    \"Державна пенітенціарна служба\",\n    \"Мінекології і Держгеонадр\",\n    \"Мінінфраструктури\",\n    \"Державне управління справами\",\n    \"Дніпропетровська ОДА\",\n    \"Мінрегіонбуд\",\n    \"Держрезерв України\",\n    \"Мінекології і Держгеонадр\",\n    \"Держкосмагентство\",\n    \"Нацакадемія аграрних наук\"\n  )\n\n#перегруппировка ведомств в ТОП-выборке\nbyHeadTop$head_short <- head_short\n\n#переименование и перегруппировка в основной БД\n#расчет суммы долга по ведомствам\ndebtByHead <- left_join(df, byHeadTop, by = \"head\") %>%\n  within(head_short[is.na(head_short)] <- \"інші\") %>%\n  group_by(head_short) %>%\n  mutate(d_sum = sum(debt))\n\n#Задание последовательности отображения ведомств\ndebtByHead$head_short <-\n  factor(debtByHead$head_short, levels = rev(append(\n    c(\n      \"Міненергетики\",\n      \"Укроборонпром і Міноборони\",\n      \"Мінагрополітики\",\n      \"Фонд держмайна\",\n      \"Мінекономрозвитку\",\n      \"Мінекології і Держгеонадр\",\n      \"Державна пенітенціарна служба\",\n      \"Мінінфраструктури\",\n      \"Державне управління справами\",\n      \"Дніпропетровська ОДА\",\n      \"Мінрегіонбуд\",\n      \"Держрезерв України\",\n      \"Держкосмагентство\",\n      \"Нацакадемія аграрних наук\"\n    ),\n    \"інші\"\n  )))\n\n#график №2\ndebtByHeadPlot <- ggplot(data = debtByHead) +\n  geom_bar(\n    mapping = aes(x = head_short, fill = factor(\n      debtor, levels = c(\"ДП з боргом\", \"ДП без боргу\")\n    )),\n    color = \"#FFFFFF\",\n    position = \"fill\"\n  ) +\n  coord_flip() +\n  scale_y_continuous(labels = percent) +\n  scale_fill_manual(values = rev(c(debtByHeadColors[3], debtByHeadColors[5])),\n                    guide = guide_legend(reverse = TRUE)) +\n  geom_text(\n    data = unique(debtByHead[, c(\"head_short\", \"d_sum\")]),\n    mapping = aes(\n      x = head_short,\n      label = ifelse(\n        d_sum / 1000000000 > 1,\n        paste(sprintf(\n          \"%3.1f\", round(d_sum / 1000000000, digits = 1)\n        ), \"млрд\", sep = \" \"),\n        paste(ceiling(d_sum / 1000000), \"млн\", sep = \" \")\n      ),\n      y = 1\n    ),\n    hjust = 1.1,\n    vjust = 0.35,\n    size = 3,\n    color = \"#FFFFFF\"\n  ) +\n  theme(\n    text = element_text(family = \"PT Sans\", size = 19),\n    plot.title = element_text(\n      face = \"bold\",\n      margin = margin(\n        t = 0,\n        r = 20,\n        b = 20,\n        l = 20,\n        unit = \"pt\"\n      )\n    ),\n    plot.subtitle = element_text(\n      size = rel(0.65),\n      margin = margin(\n        t = 0,\n        r = 20,\n        b = 35,\n        l = 20,\n        unit = \"pt\"\n      )\n    ),\n    legend.text = element_text(\n      size = rel(0.6),\n      margin = margin(\n        t = 0,\n        r = 20,\n        b = 30,\n        l = 20,\n        unit = \"pt\"\n      )\n    ),\n    axis.text.y = element_text(size = rel(0.63)),\n    axis.text.x = element_text(size = rel(0.5)),\n    axis.title.x = element_text(size = rel(0.6)),\n    panel.grid.major = element_blank(),\n    panel.grid.minor = element_blank(),\n    panel.background = element_blank(),\n    axis.ticks.y = element_blank(),\n    axis.title.y = element_blank(),\n    legend.position = \"top\",\n    legend.title = element_blank(),\n    plot.margin = unit(c(45, 20, 40, 20), \"pt\")\n  ) +\n  labs(y = \"питома вага боржників (%) і абсолютна сума боргу (грн)\",\n       title = \"Розподіл податкового боргу ДП\\nза контролюючими відомствами\",\n       subtitle = \"ДП, які використовують природні ресурси країни і підтримують\\nїї обороноздатність (підпорядковані Міненергетики і Міноборони),\\nопинились серед найбільших бюджетних боржників.\")\n\nq <-\n  arrangeGrob(debtByHeadPlot,\n              bottom = textGrob(\n                footnote,\n                x = 0,\n                hjust = -0.5,\n                vjust = -0.5,\n                gp = gpar(fontface = \"italic\", fontsize = 10)\n              ))\n\n#вывод графиков\ngrid.draw(g) #1\n\ngrid.newpage() #очистка страницы\n\ngrid.draw(q) #2\n",
    "created" : 1487074779333.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "3436764776",
    "id" : "D6408505",
    "lastKnownWriteTime" : 1486801531,
    "last_content_update" : 1486801531,
    "path" : "D:/OneDrive/my_git_repos/tax_debt/dp_debt_plotting.R",
    "project_path" : null,
    "properties" : {
    },
    "relative_order" : 10,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_source"
}